#!/usr/bin/make -f
# ekg2 package rules file
# Copyright 2002-2010 Marcin Owsiany <porridge@debian.org>

# Help cross-compiling
# These are set automatically by dpkg-buildpackage, but we cannot depend on
# them being available, because caller might not be using dpkg-buildpackage
DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

# This is to ease debugging, until ekg2 stabilizes: #379162
DEB_BUILD_OPTIONS=nostrip noopt
export DEB_BUILD_OPTIONS

# TODO: this might not be necessary with dh.
CFLAGS += -g
ifneq (,$(filter noopt,$(DEB_BUILD_OPTIONS)))
  CFLAGS += -O0
else
  CFLAGS += -O2
endif
export CFLAGS

# dh_strip will take care of nostrip

# TODO: this might not be necessary with dh either.
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
   NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
   MAKEFLAGS += -j$(NUMJOBS)
endif

-include /usr/share/topgit/tg2quilt.mk

%:
	dh --with quilt,python-central $@

# Remember to update README.Debian as well...
override_dh_auto_configure:
	EKG2_NO_COLOR_CONFIGURE=1 ./configure \
		--host=$(DEB_HOST_GNU_TYPE) \
		--build=$(DEB_BUILD_GNU_TYPE) \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=\$${prefix}/share/man \
		--infodir=\$${prefix}/share/info \
		--libexecdir=\$${prefix}/lib/ekg2 \
		--with-ioctld \
		--with-libgadu \
		--with-pthread \
		--with-openssl \
		--with-libgnutls \
		--with-expat \
		--with-ncurses \
		--with-gtk \
		--without-libgsm \
		--with-perl \
		--with-python \
		--with-libxosd \
		--with-sqlite3 \
		--without-logsoracle \
		--with-aspell \
		--without-libjpeg \
		--without-libungif \
		--without-libgif \
		--with-gpm-mouse \
		--with-gpg \
		--with-zlib \
		--without-readline \
		--enable-remote \
		--enable-unicode \
		--enable-skip-relative-plugins-dir
# Reasons for disabling some features are in README.Debian
# Remember to update README.Debian as well...

override_dh_auto_build:
	@echo 'Building with MAKEFLAGS=$(MAKEFLAGS) and CFLAGS=$(CFLAGS)'
	$(MAKE) PERL_MM_OPT=INSTALLDIRS=vendor
	cd docs/ && XSLTRANSFORMER='xsltproc --nonet' sh generate-ekg2book.sh pl generate
	cd docs/ && XSLTRANSFORMER='xsltproc --nonet' sh generate-ekg2book.sh en generate
	cd docs/ && ./generate-doc.sh
# dh_installman gets confused with the ".en" part and either chooses wrong directory or extension
	cp docs/ekg2.en.1 docs/ekg2.1
	cp docs/ekg2-remote.en.1 docs/ekg2-remote.1

override_dh_auto_clean:
	cd docs && sh generate-ekg2book.sh pl clean
	cd docs && sh generate-ekg2book.sh en clean
	rm -rf docs/doxygen
	if [ -e Makefile ] ; then $(MAKE) distclean ; fi
	rm -f docs/ekg2.1 docs/ekg2-remote.1
# Copy config.{sub,guess} if they are available and differ.
	for ext in sub guess; do \
	 if test -r /usr/share/misc/config.$$ext && ! cmp --quiet /usr/share/misc/config.$$ext config.$$ext ; then \
	  cp -fv /usr/share/misc/config.$$ext config.$ext ; \
	 fi ; \
	done

override_dh_auto_install:
	perl_install_args="DESTDIR=$(CURDIR)/debian/ekg2 INSTALLDIRS=vendor" $(MAKE) install prefix=$(CURDIR)/debian/ekg2/usr
# Apparently INSTALLDIRS=vendor is not enough in some cases. Remove packfiles manually.
	find debian/ekg2 -type f -name .packlist | xargs -r rm -f

override_dh_installdocs:
	dh_installdocs
	cp -a docs/ekg2book/book    $(CURDIR)/debian/ekg2/usr/share/doc/ekg2/book-pl
	cp -a docs/ekg2book-en/book $(CURDIR)/debian/ekg2/usr/share/doc/ekg2/book-en
	cp -a docs/doxygen          $(CURDIR)/debian/ekg2/usr/share/doc/ekg2/
